= Lab1 - Automating Deployments Using Pipelines
:experimental:
:imagesdir: images


In this step, we are now going to setup a pipeline and explore some best practices and techniques for developers and DevOps teams for getting code from the developer *(that’s YOU!)* with less downtime and greater consistency.


== Production vs. Development

In a real project on OpenShift, _dev_, _test_ and _production_ environments would typically use different OpenShift projects and perhaps even different OpenShift clusters.

For simplicity in this scenario we will use a only one environment, and no _dev_, _test_ or _prod_ environment.

=== 1. Create a database

you can create a database using the following via CodeReady Workspaces Terminal window:

[source,sh,role="copypaste"]
----
oc project {{ USER_ID }}-inventory && \
oc new-app -e POSTGRESQL_USER=catalog \
             -e POSTGRESQL_PASSWORD=mysecretpassword \
             -e POSTGRESQL_DATABASE=catalog \
             openshift/postgresql:latest \
             --name=catalog-database
----

You can log into the running Postgres container using the following via CodeReady Workspaces Terminal window:

[source,sh,role="copypaste"]
----
oc rsh deployment/catalog-database
----

Once logged in, use the following commands to execute an SQL statement to insert content to the database and then exit:

[source,sh,role="copypaste"]
----
psql -U catalog;   
----


[source,sh,role="copypaste"]
----
DROP TABLE IF EXISTS catalog;

CREATE TABLE catalog (
  itemId VARCHAR(256) NOT NULL PRIMARY KEY,
  name VARCHAR(256),
  description VARCHAR(2560),
  price DOUBLE PRECISION
);


insert into catalog (itemId, name, description, price) values ('329299', 'Quarkus T-shirt', '', 10.00);
insert into catalog (itemId, name, description, price) values ('329199', 'Pronounced Kubernetes', '', 9.00);
insert into catalog (itemId, name, description, price) values ('165613', 'Knit socks', '',4.15);
insert into catalog (itemId, name, description, price) values ('165614', 'Quarkus H2Go water bottle', '', 14.45);
insert into catalog (itemId, name, description, price) values ('165954', 'Patagonia Refugio pack 28L', '', 6.00);
insert into catalog (itemId, name, description, price) values ('444434', 'Red Hat Impact T-shirt', '', 9.00);
insert into catalog (itemId, name, description, price) values ('444435', 'Quarkus twill cap', '',13.00 );
insert into catalog (itemId, name, description, price) values ('444437', 'Nanobloc Universal Webcam Cover', '', 2.75);
----


[source,sh,role="copypaste"]
----
exit; exit
----


=== 2. Create pipeline and deploy Catalog app

In the developer view go to +Add --> Import from Git 

Fill in the fields, click on Show advanced Git options, and click `Create`:

image::import-from-git-1.png[import-from-git-1, 1000]

* Git Repo URL: https://github.com/pkstaz/cloud-native-workshop-v2m2-labs.git
* Git reference: ocp-4.10
* Context dir: /catalog

[NOTE]
====
The assistant will recognized and recommend the image for the app code 
====

image::import-from-git-2.png[import-from-git-2, 1000]

* Application: Create Application
* Application name: catalog
* Name: catalog-app
* Select the resource type to generate: Deployment 


image::import-from-git-3.png[import-from-git-3, 1000]

* Check Add Pipelines
* Check Create a route to the Application

You can see the pipeline run in the Pipelines menu.

image::pipeline-run.png[pipeline-run, 1000]


[NOTE]
====
Wait 2-3 minutes for the deployment to finish.
For the next step is important that you pipeline is done.
====

Go to the {{ CONSOLE_URL }}/topology/ns/{{ USER_ID }}-inventory[Topology View^] to see the elements that were deployed.

The Topology view in the Developer perspective of the web console provides a visual representation of all the applications within a project, their build status, and the components and services associated with them.

Label the components so that they get proper icons by running this command in the CodeReady Terminal:

[source,sh,role="copypaste"]
----
oc project {{USER_ID}}-inventory && \
oc label deployment/catalog-database app.openshift.io/runtime=postgresql --overwrite && \
oc label deployment/catalog-app app.openshift.io/runtime=spring-boot --overwrite && \
oc label deployment/catalog-database app.kubernetes.io/part-of=catalog --overwrite && \
oc label deployment/catalog-app app.kubernetes.io/part-of=catalog --overwrite && \
oc annotate deployment/catalog-app app.openshift.io/connects-to=catalog-database --overwrite && \
oc annotate deployment/catalog-app app.openshift.io/vcs-uri=https://github.com/pkstaz/cloud-native-workshop-v2m2-labs.git --overwrite && \
oc annotate deployment/catalog-app app.openshift.io/vcs-ref=ocp-4.10 --overwrite
----


=== 3. Verify Catalog App

If you pipeline done success and to give a better look run the following commands




